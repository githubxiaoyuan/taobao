"use strict";$(function(){function n(){layui.use("layer",function(){return localStorage.getItem("token")?void $.ajax({url:"/shop/cartInfo",method:"POST",success:function(t){if(1!==t.status)return $(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">'+t.message+"</h2>"),layer.msg(t.message);if(0<t.data.length){for(var e=[],a=0;a<t.data.length;a++)-1===e.indexOf(t.data[a].shop_name)&&e.push(t.data[a].shop_name);for(var s="",a=0;a<e.length;a++){for(var i="",c=0;c<t.data.length;c++)t.data[c].shop_name===e[a]&&(i+='<div class="cart-item-inner clearfix"><div class="p-checkbox"><div class="td-inner"><span class="diy-checkbox goods-select-checkbox"data-checked="false"></span><input type="hidden" class="s-goods-id" value="'+t.data[c].goods_id+'"></div></div><div class="p-goods"><div class="td-inner"><div class="p-img"><a href="./item.html?id='+t.data[c].goods_id+'"><img src="'+t.data[c].goods_img+'"alt=""></a></div><div class="p-msg"><a href="./item.html?id='+t.data[c].goods_id+'">'+t.data[c].goods_name+'</a></div></div></div><div class="p-category"><div class="td-inner"></div></div><div class="p-price"><div class="td-inner"><div class="td-item-price"><p class="price-line"><em class="now-price">￥'+parseFloat(t.data[c].goods_price).toFixed(2)+'</em></p></div></div></div><div class="p-num"><div class="td-inner"><div class="quantity-form"><a href="javascript:;"class="decrement btn">-</a><input type="text"class="itxt s-goods-num" value="'+t.data[c].goods_num+'"><a href="javascript:;"class="increment btn">+</a></div></div></div><div class="p-sum"><div class="td-inner"><em class="item-price-sum">￥'+(parseFloat(t.data[c].goods_price)*parseInt(t.data[c].goods_num)).toFixed(2)+'</em></div></div><div class="p-action"><div class="td-inner"><a href="javascript:;" class="s-collect-goods">移入收藏夹</a><a href="javascript:;" class="s-del-goods">删除</a></div></div></div>');s+='<div class="cart-item check-cart-item clearfix"><div class="shop-info clearfix"><div class="shop-checkbox-wrap"><span class="diy-checkbox shop-select-checkbox"data-checked="false"></span></div><div class="shop-name-box"><span>&nbsp;&nbsp;店铺：</span><a href="javascript:;"class="shop-name">'+e[a]+'</a><a href="javascript:;"class="wangwang-icon"></a></div></div>'+i+"</div>"}$(".cart-item-list").html(s)}else $(".all-select-checkbox").attr("data-checked","false"),$(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;"><a href="./goodslist.html">您的购物车为空，请去添加商品吧！</a></h2>');$(".diy-checkbox").on("click",function(){"false"===$(this).attr("data-checked")?$(this).attr("data-checked","true"):$(this).attr("data-checked","false"),d(),l()}),$(".all-select-checkbox").on("click",function(){"true"===$(this).attr("data-checked")?$(".diy-checkbox").attr("data-checked","true"):"false"===$(this).attr("data-checked")&&$(".diy-checkbox").attr("data-checked","false"),d(),l()}),$(".shop-select-checkbox").on("click",function(){"true"===$(this).attr("data-checked")?$(this).parents(".cart-item").find(".goods-select-checkbox").attr("data-checked","true"):"false"===$(this).attr("data-checked")&&$(this).parents(".cart-item").find(".goods-select-checkbox").attr("data-checked","false");var a=!0;$.each($(".goods-select-checkbox"),function(t,e){"false"===$(e).attr("data-checked")&&(a=!1)}),a?$(".all-select-checkbox").attr("data-checked","true"):$(".all-select-checkbox").attr("data-checked","false"),d(),l()}),$(".goods-select-checkbox").on("click",function(){var a=!0;$.each($(this).parents(".cart-item").find(".goods-select-checkbox"),function(t,e){"false"===$(e).attr("data-checked")&&(a=!1)}),a?$(this).parents(".cart-item").find(".shop-select-checkbox").attr("data-checked","true"):$(this).parents(".cart-item").find(".shop-select-checkbox").attr("data-checked","false");var s=!0;$.each($(".goods-select-checkbox"),function(t,e){"false"===$(e).attr("data-checked")&&(s=!1)}),s?$(".all-select-checkbox").attr("data-checked","true"):$(".all-select-checkbox").attr("data-checked","false")}),document.querySelector(".cart-item-list").oninput=function(t){t=(t=t||window.event).target||src.element;-1!==t.className.indexOf("s-goods-num")&&r(t)},$(".cart-item-list").on("click",".increment",function(){$(this).hasClass("ban")||($(this).siblings(".s-goods-num").val(parseInt($(this).siblings(".s-goods-num").val())+1),r($(this).siblings(".s-goods-num").get(0)))}),$(".cart-item-list").on("click",".decrement",function(){$(this).hasClass("ban")||($(this).siblings(".s-goods-num").val(parseInt($(this).siblings(".s-goods-num").val())-1),r($(this).siblings(".s-goods-num").get(0)))}),$(".cart-item-list").on("click",".s-del-goods",function(){var i=$(this);layui.use("layer",function(){var s=layui.layer;s.open({title:"确认删除",content:"您确定要删除该商品吗？",btn:["确定","取消"],btn1:function(t,e){localStorage.getItem("token")?$.ajax({url:"/shop/deleteCartGoods",method:"POST",data:{goodsId:parseInt(i.parents(".cart-item-inner").find(".s-goods-id").val())},success:function(t){if(1!==t.status)return s.msg(t.message);s.msg(t.message),(1<i.parents(".cart-item").find(".cart-item-inner").length?i.parents(".cart-item-inner"):i.parents(".cart-item")).remove(),d(),l(),o(),m();var a=!0;$.each($(".goods-select-checkbox"),function(t,e){"false"===$(e).attr("data-checked")&&(a=!1)}),a?$(".all-select-checkbox").attr("data-checked","true"):$(".all-select-checkbox").attr("data-checked","false")}}):(s.msg("身份认证失败，请重新登陆！"),setTimeout(function(){return location.href="./login.html?source="+location.href},2e3))}})})}),layui.use("layer",function(){var a=layui.layer;$(".remove-batch").on("click",function(){localStorage.getItem("token")?a.confirm("您确定要删除选中商品吗？",{icon:3,title:"确认删除"},function(t){$.each($('.goods-select-checkbox[data-checked="true"]'),function(t,e){$.ajax({url:"/shop/deleteCartGoods",method:"POST",data:{goodsId:parseInt($(e).parents(".cart-item-inner").find(".s-goods-id").val())},success:function(t){if(1!==t.status)return a.msg(t.message);a.msg(t.message),(1<$(e).parents(".cart-item").find(".cart-item-inner").length?$(e).parents(".cart-item-inner"):$(e).parents(".cart-item")).remove(),d(),l(),o(),m(),$(".all-select-checkbox").attr("data-checked","false"),$.ajax({url:"/shop/cartInfo",method:"POST",success:function(t){if(1!==t.status)return $(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">'+t.message+"</h2>"),a.msg(t.message);0===t.data.length&&$(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;"><a href="./goodslist.html">您的购物车为空，请去添加商品吧！</a></h2>')},error:function(){return $(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">获取购物车失败，请检查网络设置！</h2>'),a.msg("获取购物车失败，请检查网络设置！")}})}})}),a.close(t)}):(a.msg("身份认证失败，请重新登陆！"),setTimeout(function(){return location.href="./login.html?source="+location.href},2e3))})}),layui.use("layer",function(){var a=layui.layer;$("#cartSettlementBtn").on("click",function(t){t.preventDefault(),"false"===$(this).attr("data-disabled")&&(localStorage.getItem("token")?a.confirm("您确定要结算选中商品吗？",{icon:3,title:"确认结算"},function(t){$.each($('.goods-select-checkbox[data-checked="true"]'),function(t,e){$.ajax({url:"/shop/settlement",method:"POST",data:{goodsId:parseInt($(e).parents(".cart-item-inner").find(".s-goods-id").val()),goodsNum:parseInt($(e).parents(".cart-item-inner").find(".s-goods-num").val())},success:function(t){if(1!==t.status)return a.msg(t.message);a.msg(t.message),(1<$(e).parents(".cart-item").find(".cart-item-inner").length?$(e).parents(".cart-item-inner"):$(e).parents(".cart-item")).remove(),d(),l(),o(),$(".all-select-checkbox").attr("data-checked","false"),m(),$.ajax({url:"/shop/cartInfo",method:"POST",success:function(t){if(1!==t.status)return $(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">'+t.message+"</h2>"),a.msg(t.message);0===t.data.length&&$(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;"><a href="./goodslist.html">您的购物车为空，请去添加商品吧！</a></h2>')},error:function(){return $(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">获取购物车失败，请检查网络设置！</h2>'),a.msg("获取购物车失败，请检查网络设置！")}})}})}),a.close(t)}):(a.msg("身份认证失败，请重新登陆！"),setTimeout(function(){return location.href="./login.html?source="+location.href},2e3)))})}),layui.use("layer",function(){var e=layui.layer;$(".clear-all").on("click",function(){e.confirm("您确定要清空购物车吗？这将会删除购物车中的所有商品！",{icon:3,title:"确认清空购物车"},function(t){localStorage.getItem("token")?$.ajax({url:"/shop/clearGoods",method:"POST",success:function(t){if(1!==t.status)return e.msg(t.message);e.msg(t.message),n(),m()}}):(e.msg("身份认证失败，请重新登陆！"),setTimeout(function(){return location.href="./login.html?source="+location.href},2e3)),e.close(t)})})}),d(),l(),o()},error:function(){return $(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">获取购物车失败，请检查网络设置！</h2>'),d(),l(),o(),layer.msg("获取购物车失败，请检查网络设置！")}}):($(".cart-item-list").html('<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;"><a href="./login.html">您还未登录，请登陆后查看购物车！</a></h2>'),layer.msg("您还未登录，请登陆后查看购物车！"))})}function o(){var t=document.querySelector(".cart-floatbar-box"),e=t.querySelector(".cart-floatbar");window.onresize=function(){window.innerHeight>t.offsetTop?e.className="cart-floatbar":e.className="cart-floatbar cart-floatbar-fixed",window.onscroll()},window.onscroll=function(){window.innerHeight>t.offsetTop||document.documentElement.scrollTop+window.innerHeight>=t.offsetTop?e.className="cart-floatbar":e.className="cart-floatbar cart-floatbar-fixed"},window.onresize()}function r(e){var a=parseInt($(e).parents(".cart-item-inner").find(".s-goods-id").val());parseInt(e.value)&&1!=e.value?$.ajax({url:"/api/item/goods_num",method:"GET",data:{goodsId:parseInt($(e).parents(".cart-item-inner").find(".s-goods-id").val())},success:function(t){parseInt(e.value)>=parseInt(t.data.goods_reserve)?(e.value=parseInt(t.data.goods_reserve),i(a,parseInt(e.value)),s(e),l(),$(e).siblings(".increment").addClass("ban"),layer.msg("已达到最大库存量，不能再继续添加！")):(e.value=parseInt(e.value),i(a,parseInt(e.value)),s(e),l(),$(e).siblings(".increment").removeClass("ban")),1<parseInt(e.value)&&$(e).siblings(".decrement").removeClass("ban")}}):(e.value=1,i(a,parseInt(e.value)),s(e),l(),$(e).siblings(".decrement").addClass("ban"))}function s(t){$(t).parents(".cart-item-inner").find(".item-price-sum").text("￥"+(parseInt($(t).val())*parseFloat($(t).parents(".cart-item-inner").find(".now-price").text().replace("￥",""))).toFixed(2))}function i(t,a){layui.use("layer",function(){var e=layui.layer;localStorage.getItem("token")?$.ajax({url:"/shop/updateGoodsNum",method:"POST",data:{goodsId:t,goodsNum:a},success:function(t){if(1!==t.status)return e.msg(t.message)},error:function(){return e.msg("更新数据库失败，请检查网络设置！")}}):(e.msg("身份认证失败，请重新登陆！"),setTimeout(function(){return location.href="./login.html?source="+location.href},2e3))})}function l(){var a=0,s=0;$.each($(".goods-select-checkbox"),function(t,e){"true"===$(e).attr("data-checked")&&(s++,a+=parseFloat($(e).parents(".cart-item-inner").find(".item-price-sum").text().replace("￥","")))}),$(".amount-sum-num").text(s),$(".price-sum-num").text(a.toFixed(2))}function d(){var a=!0;$.each($(".goods-select-checkbox"),function(t,e){"true"===$(e).attr("data-checked")&&($("#cartSettlementBtn").attr("data-disabled","false"),a=!1)}),a&&$("#cartSettlementBtn").attr("data-disabled","true")}function m(){layui.use("layer",function(){$.ajax({url:"/shop/cartInfo",method:"POST",success:function(t){if(1!==t.status)return $(".shopping-cart-menu").html("<p>"+t.message+'<a href="./login.html" class="my-shopping-cart-link">重新登录</a></p>'),layer.msg(t.message);if($(".header-right-nav .shopping-cart .good-num").text(t.data.length),0<t.data.length){for(var e="",a=0;a<t.data.length&&!(3<=a);a++)e+='<div class="mini-item clearfix"><div class="mini-goods-img-wrap"><a href="./item.html?id='+t.data[a].goods_id+'"><img src="'+t.data[a].goods_img+'" alt="" title="'+t.data[a].goods_name+'"></a></div><div class="mini-goods-title"><h4><a href="./item.html?id='+t.data[a].goods_id+'" title="'+t.data[a].goods_name+'">'+t.data[a].goods_name+'</a></h4></div><div class="mini-goods-right"><div class="mini-goods-price"><em class="rmb-symbol">￥</em><em class="goods-price">'+parseFloat(t.data[a].goods_price).toFixed(2)+'</em></div><div class="goods-option"><a href="javascript:;" class="hd-mini-cart-delete">删除</a></div></div></div>';var s='<div class="mini-cart-hd"><h4>最近加入的宝贝：</h4></div><div class="mini-cart-goods">'+e+'</div><div class="mini-cart-ft clearfix"><h3>更多请查看完整版购物车→</h3><a href="./cart.html" class="my-shopping-cart-link">查看我的购物车</a></div>';$(".shopping-cart-menu").html(s)}else $(".shopping-cart-menu").html('<p>您购物车里还没有任何宝贝。<a href="./cart.html" class="my-shopping-cart-link">查看我的购物车</a></p>')},error:function(){return $(".shopping-cart-menu").html('<p>请检查网络设置，或者重新登陆。<a href="./login.html" class="my-shopping-cart-link">重新登录</a></p>'),layer.msg("请求购物车信息失败，请检查网络设置！")}})})}n()});