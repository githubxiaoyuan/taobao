"use strict";renderHeaderShopCart();var goodsId=parseInt(location.search.substr(location.search.indexOf("=")+1)),goodsMain=document.querySelector(".goods-main");function addGoods(){layui.use("layer",function(){var i=layui.layer,e=document.getElementsByClassName("tb-goods-num")[0];function a(a){parseInt(e.value)&&1!=e.value?$.ajax({url:"/api/item/goods_num",method:"GET",data:{goodsId:goodsId},success:function(s){parseInt(e.value)>=parseInt(s.data.goods_reserve)?(e.value=parseInt(s.data.goods_reserve),$(".tb-add-goods").addClass("ban"),i.msg("已达到最大库存量，不能再继续添加！")):(e.value=parseInt(e.value),$(".tb-add-goods").removeClass("ban")),1<parseInt(e.value)&&$(".tb-reduce-goods").removeClass("ban"),a&&a()},error:function(){return i.msg("获取商品库存失败，请检查网络设置！")}}):(e.value=1,$(".tb-reduce-goods").addClass("ban"),a&&a())}e.oninput=function(){a()},$(".tb-add-goods").on("click",function(){$(this).hasClass("ban")||($(e).val(parseInt($(e).val())+1),a())}),$(".tb-reduce-goods").on("click",function(){$(this).hasClass("ban")||($(e).val(parseInt($(e).val())-1),a())}),$(".add-goods-btn").on("click",function(){var s;localStorage.getItem("token")?(s={goodsId:goodsId,goodsNum:parseInt(e.value)},a(function(){$.ajax({url:"/shop/addGoods",method:"POST",data:s,success:function(s){if(1!==s.status)return i.msg(s.message);renderHeaderShopCart(),i.msg(s.message)},error:function(){return i.msg("加入购物车失败，请检查网络设置！")}})})):(i.msg("请先登录！"),setTimeout(function(){return location.href="./login.html?source="+location.href},1500))})})}function zoom(){var a=document.querySelector(".goods-pre-img"),i=a.querySelector(".mask"),e=a.querySelector(".preview-box"),s=a.querySelector(".bigImg-box"),d=a.querySelector(".bigImg-wrap"),o=e.clientWidth*s.clientWidth/d.clientWidth;i.style.width=o+"px",i.style.height=o+"px",s.style.display="none",e.onmouseenter=function(){i.style.display="block",s.style.display="block"},e.onmouseleave=function(){i.style.display="none",s.style.display="none"},e.onmousemove=function(s){s.pageX-a.offsetLeft-a.clientLeft>i.offsetWidth/2?i.style.left=s.pageX-a.offsetLeft-a.clientLeft-i.offsetWidth/2+"px":i.style.left="0px",s.pageY-a.offsetTop-a.clientTop>i.offsetHeight/2?i.style.top=s.pageY-a.offsetTop-a.clientTop-i.offsetHeight/2+"px":i.style.top="0px",a.clientWidth-(s.pageX-a.offsetLeft)<=i.offsetWidth/2&&(i.style.left=a.offsetWidth-Math.ceil(parseFloat(i.style.width))+"px"),a.clientHeight-(s.pageY-a.offsetTop)<=i.offsetHeight/2&&(i.style.top=a.offsetHeight-Math.ceil(parseFloat(i.style.height))+"px"),d.style.transform="translate("+-parseFloat(i.style.left)*d.offsetWidth/e.clientWidth+"px,"+-parseFloat(i.style.top)*d.offsetHeight/e.clientHeight+"px)"}}function renderHeaderShopCart(){layui.use("layer",function(){localStorage.getItem("token")?$.ajax({url:"/shop/cartInfo",method:"POST",success:function(s){if(1!==s.status)return $(".shopping-cart-menu").html("<p>"+s.message+'<a href="./login.html" class="my-shopping-cart-link">重新登录</a></p>'),layer.msg(s.message);if($(".header-right-nav .shopping-cart .good-num").text(s.data.length),0<s.data.length){for(var a="",i=0;i<s.data.length&&!(3<=i);i++)a+='<div class="mini-item clearfix"><div class="mini-goods-img-wrap"><a href="./item.html?id='+s.data[i].goods_id+'"><img src="'+s.data[i].goods_img+'" alt="" title="'+s.data[i].goods_name+'"></a></div><div class="mini-goods-title"><h4><a href="./item.html?id='+s.data[i].goods_id+'" title="'+s.data[i].goods_name+'">'+s.data[i].goods_name+'</a></h4></div><div class="mini-goods-right"><div class="mini-goods-price"><em class="rmb-symbol">￥</em><em class="goods-price">'+parseFloat(s.data[i].goods_price).toFixed(2)+'</em></div><div class="goods-option"><a href="javascript:;" class="hd-mini-cart-delete">删除</a></div></div></div>';var e='<div class="mini-cart-hd"><h4>最近加入的宝贝：</h4></div><div class="mini-cart-goods">'+a+'</div><div class="mini-cart-ft clearfix"><h3>更多请查看完整版购物车→</h3><a href="./cart.html" class="my-shopping-cart-link">查看我的购物车</a></div>';$(".shopping-cart-menu").html(e)}else $(".shopping-cart-menu").html('<p>您购物车里还没有任何宝贝。<a href="./cart.html" class="my-shopping-cart-link">查看我的购物车</a></p>')},error:function(){return $(".shopping-cart-menu").html('<p>请检查网络设置，或者重新登陆。<a href="./login.html" class="my-shopping-cart-link">重新登录</a></p>'),layer.msg("请求购物车信息失败，请检查网络设置！")}}):$(".shopping-cart-menu").html('<p>您还未登录，请先登录。<a href="./login.html" class="my-shopping-cart-link">点我登录</a></p>')})}$.ajax({url:"/api/item",method:"GET",data:{id:goodsId},success:function(s){switch(s.status){case 0:goodsMain.innerHTML='<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">数据库连接错误，请检查设置！</h2>';break;case 2:goodsMain.innerHTML='<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">数据库请求过程中发生错误，请重新尝试！</h2>';break;case 3:goodsMain.innerHTML='<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">很遗憾，所请求的商品不存在！</h2>';break;case 1:var a=s.data;document.title=a.goods_title;var i="";a.gold_periods&&(i='<div class="gold-seller"><a href="javascript:;"><div class="gold-periods">连续<span class="gold-periods-num">'+a.gold_periods+'</span>期</div><img src="./images/gold-seller.png" alt=""></a><a href="javascript:;" class="gold-img-wrap"></a></div>'),a.shop_years&&(i+='<div class="shop-age"><a href="javascript:;"><div class="shop-age-content"><i class="shop-age-icon"></i><span class="shop-age-num">'+a.shop_years+'</span><span class="shop-age-text">年老店</span></div></a></div>');var e=a.goods_desc.replace(/\/\/img.alicdn.com\/tps\/i4\/T10B2IXb4cXXcHmcPq-85-85.gif/gi,"./images/loading.gif"),d=a.goods_params.replace(/<img src/gi,'<img src="./images/loading.gif" data-src'),e='<div class="goods-detail-info clearfix"><div class="goods-info-left clearfix"><div class="goods-pre-img"><div class="preview-box"><div class="mask"></div><img src="'+a.goods_img+'" alt=""></div><div class="bigImg-box"><div class="bigImg-wrap"><img src="'+a.goods_img+'" alt="" class="big-img"></div></div></div><div class="goods-info-wrap"><div class="goods-info-inner"><div class="goods-title"><h3>'+a.goods_title+'</h3></div><div class="sales-box"><ul class="clearfix"><li class="price-box"><span class="txt">价格</span><strong><em class="rmb-symbol">￥</em><em class="goods-price">'+a.goods_price.toFixed(2)+'</em></strong></li><li class="goods-data-count clearfix"><div class="cmt-box"><a href="javascript:;"><strong class="cmt-count">'+a.cmt_num+'</strong><span>累计评论</span></a></div><div class="sales-data"><a href="javascript:;"><strong class="sals-count">'+a.goods_sales+'</strong><span>交易成功</span></a></div></li></ul></div><div class="logistics"><div class="logistics-inner clearfix"><div class="line-name">配送</div><div class="logistics-info clearfix"><div class="area-info"><span class="from-address">广东深圳</span> 至 <span class="target-address">广东深圳宝安区</span></div></div></div></div><div class="purchase-box"><div class="purchase-inner"><div class="goods-amount clearfix"><div class="line-name">数量</div><div class="goods-num-box clearfix"><a href="javascript:;" class="tb-reduce-goods ban">-</a><input type="text" class="tb-goods-num" value="1"><a href="javascript:;" class="tb-add-goods">+</a></div><div class="goods-reserve">件(库存<em>'+a.goods_reserve+'</em>件)</div></div></div></div><div class="goods-action"><div class="goods-action-inner clearfix"><div class="tb-buy-wrap"><a href="javascript:;" class="buy-goods-btn">立即购买</a></div><div class="tb-add-wrap"><a href="javascript:;" class="add-goods-btn"><i class="iconfont icon-tianchongxing-"></i>加入购物车</a></div></div></div><div class="goods-service"><dl class="clearfix"><dt>承诺</dt><dd class="clearfix"><a href="javascript:;"><img src="./images/goods-service-icon1.png" alt="">15天退货</a><a href="javascript:;"><img src="./images/goods-service-icon2.png" alt="">公益宝贝</a></dd></dl><dl class="clearfix"><dt>支付</dt><dd class="clearfix"><a href="javascript:;"><img src="./images/goods-service-icon3.png" alt="">蚂蚁花呗</a><a href="javascript:;"><img src="./images/goods-service-icon4.png" alt="">信用卡支付</a></dd></dl><dl class="clearfix"><dt>支持</dt><dd class="clearfix">折旧变现，买新更省钱。<a href="javascript:;" style="float: none;display: inline;text-decoration: underline;">详情</a></dd></dl></div></div></div></div><div class="goods-info-right"><div class="shop-sidebar">'+i+'<div class="shop-info"><div class="shop-info-inner"><div class="line line1 "><span class="shop-name">'+a.shop_name+'</span></div><div class="line line2 "><dl class="clearfix"><dt>信誉：</dt><dd class="shop-reputation clearfix">'+a.reputation+'</dd></dl></div><div class="line line3 "><dl class="clearfix"><dt>掌柜：</dt><dd class=" clearfix"><span class="shopkeeper">'+a.seller+'</span></dd></dl></div><div class="line line4 "><dl class="clearfix"><dt>联系：</dt><dd class=" clearfix"><a href="javascript:;" class="contact-me"></a></dd></dl></div><div class="line line5 "><dl class="clearfix"><dt>资质：</dt><dd class=" clearfix"><a href="javascript:;" class="qualification-icon"></a><a href="javascript:;" class="shop-bond"><span class="shop-bond-icon"></span><span class="shop-bond-num">'+parseInt(a.qualify)+'<span>元</span> </span></a></dd></dl></div><div class="shop-score clearfix"><dl><dt>描述</dt><dd><a href="javascript:;" class="shop-desc-score">'+a.grade_desc.toFixed(1)+'</a></dd></dl><dl><dt>服务</dt><dd><a href="javascript:;" class="shop-service-score">'+a.grade_service.toFixed(1)+'</a></dd></dl><dl><dt>物流</dt><dd><a href="javascript:;" class="shop-logistics-score">'+a.grade_logistics.toFixed(1)+'</a></dd></dl></div><div class="shop-info-ft clearfix"><a href="javascript:;" class="shop-link">进入店铺</a><a href="javascript:;" class="collect-shop">收藏店铺</a></div></div></div></div></div></div><div class="goods-content clearfix"><div class="goods-cont-inner clearfix"><div class="goods-cont-left"></div><div class="goods-cont-right"><div class="tab-bar"><ul class="tab-bar-list clearfix"><li class="activity"><a href="javascript:;">宝贝详情</a><div class="activity-line"></div></li><li><a href="javascript:;">累计评论</a></li><li><a href="javascript:;">专享服务</a></li></ul></div><div class="main-wrap"><div class="goods-params"><div class="goods-params-inner"><h3>产品参数</h3><ul class="goods-params-list clearfix">'+d+'</ul></div></div><div class="goods-description"><div class="description-inner"><p>'+e+"</p></div></div></div></div></div></div>";goodsMain.innerHTML=e,zoom(),addGoods();break;default:goodsMain.innerHTML='<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">请求商品数据失败，原因未知！</h2>'}},error:function(s){return goodsMain.innerHTML='<h2 style="padding:100px 0;text-align:center;font-size:60px;color:#f40;">请求商品数据失败，请检查网络设置！</h2>'}});